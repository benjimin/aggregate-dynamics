<html>
<head>
<title>Aggregate Dynamics</title>
<script src="https://openlayers.org/en/v4.6.4/build/ol.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.4.4/proj4.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>
<body>

<div id="controls" style="float:left; width:20%">
Aggregate Dynamics.
<p>
<i>Use the map to draw a polygon.</i>
<p>
<form>
<label><input type="checkbox" id="snap" checked>Snap to grid</label><br>
<label><input type="checkbox" id="wofs" checked>Overlay WOfS filtered summary</label>
</form>

</div>
<div id="map" style="width:80%; height:500px; float:left"></div>


<div id="plot" style="width:100%; clear:left"></div>

<div id="plot2" style="width:100%; height:200px; clear:left"></div>

<p>
Temporal dynamics of spatially aggregated quantities with sparse measurement data
<p>


<script>
proj4.defs("EPSG:3577",
           "+proj=aea +lat_1=-18 +lat_2=-36 +lat_0=0 +lon_0=132 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs");
ol.proj.get("EPSG:3577").setExtent([-2690013.3995, -5098960.4467, 2579169.8548, -1281018.4757]);

var wofs = new ol.layer.Tile(
    {
        source: new ol.source.TileWMS(
            {
                serverType: 'geoserver',
                url: 'http://eos.ga.gov.au/geoserver/NFRIP-WOfS/wms',
                params: {'LAYERS': 'NFRIP-WOfS:WaterSummaryFiltered', 'TILED': true}
            })
    });

var vectors = new ol.source.Vector();
var format = new ol.format.GeoJSON();
var map = new ol.Map(
    {
        target: 'map',
        layers: [new ol.layer.Tile({source: new ol.source.OSM()}), wofs,
                new ol.layer.Vector({source: vectors})],
        view: new ol.View({zoom: 6,
                           //center: ol.proj.fromLonLat([135, -30]),
                           center: [1550000,-3950000],
                           projection: 'EPSG:3577'
                           })
    });
//map.getView().fit([1500000, -4000000, 1600000, -3900000]);

var draw = new ol.interaction.Draw({type: 'Polygon'});
map.addInteraction(draw);

//var example = {"type":"Polygon","coordinates":[[[16455167.579347761,-4124576.3832144104],[16563788.776690982,-4470154.756898811],[16835978.048593074,-4143997.36004168],[16455167.579347761,-4124576.3832144104]]]};
//vectors.addFeature(new ol.Feature({geometry: format.readGeometry(example)}));

function onDraw(event) {
        vectors.clear();
        //vectors.addFeature(event.feature);
        let geom = format.writeGeometryObject(event.feature.getGeometry());
        let snap = $('#snap').is(':checked');
        $('#plot').html("Requesting..");
        $.ajax(
            {
                url: '../plot',
                data: JSON.stringify({"snap":snap,
                                      "geometry":geom,
                                      "width":$('#plot2').width()
                                      }),
                type: 'POST',
                contentType: 'application/json',
                dataType: 'json',
                success: onReply
            });
};



var w = $('#plot2').width(),
    h = $('#plot2').height(),
    m = 20;

console.log(w);
console.log(h);

var svg = d3.select('#plot2').append("svg").attr("width", w).attr("height", h);

svg.append("rect").attr("width", w).attr("height", h)
        .style("fill", "none").style("stroke", "black");

w = w - m - m;
h = h - m - m;

var x = d3.scaleTime().range([0, w]);
var y = d3.scaleLinear().range([h, 0]);

var bottom = svg.append("g").attr("transform", "translate(20, 180)");
var xaxismaker = d3.axisBottom(x);
var left = svg.append("g").attr("transform", "translate(20, 20)");
var yaxismaker = d3.axisLeft(y);

var plotregion = svg.append("g").attr("transform", "translate(20,20)");

var r = plotregion.append("rect").attr("width", w).attr("height", h)
    .style("fill", "none").style("stroke", "black");

var estimate = d3.line()
                     .x(d => x(d[0]))
                     .y(d => y(d[2]));
var uncertainty = d3.area()
                     .x(d => x(d[0]))
                     .y0(d => y(d[1]))
                     .y1(d => y(d[3]));

var curve = plotregion.append("path").style("fill", "none").style("stroke", "#00F");
var envelope = plotregion.append("path").style("fill", "#005").style("stroke", "#00F");

var dates;
var data;
var coords;

function onReply(response) {
    let poly = format.readFeature(response['geometry']);
    vectors.addFeature(poly);
    $('#plot').html(response['output']);

    dates = response['dates'].map(x => new Date(x));
    data = response['data'];

    data = [...data.keys()].map(i => [dates[i], ...data[i]]);

    x.domain([dates[0], dates.slice(-1)[0]]);
    y.domain([d3.min(data.map(d => d[1])), d3.max(data.map(d=>d[3]))]);

    curve.datum(data).attr("d", estimate);
    envelope.datum(data).attr("d", uncertainty);
    bottom.call(xaxismaker);
    left.call(yaxismaker);


};

draw.on('drawend', onDraw);

$('#wofs').change(function() {
    wofs.setVisible( $(this).is(':checked') );
});

var zoomcatcher = d3.zoom().on("zoom", zoomhandler);

svg.call(zoomcatcher);

function zoomhandler() {
    x.domain(d3.event.transform.rescaleX(x).domain());
    curve.attr("d", estimate);
    envelope.attr("d", uncertainty);
    bottom.call(xaxismaker);
};

</script>
</body>
</html>